#! /bin/sh
# obtain and export Rs environment variables
export R_HOME
CXX=$(${R_HOME}/bin/R CMD config CXX)
CXXFLAGS="$(${R_HOME}/bin/R CMD config CXXFLAGS)"
CPPFLAGS=$(${R_HOME}/bin/R CMD config CPPFLAGS)
BLAS_LIBS=$(${R_HOME}/bin/R CMD config BLAS_LIBS)
LAPACK_LIBS=$(${R_HOME}/bin/R CMD config LAPACK_LIBS)
export CXX
export CXXFLAGS
export CPPFLAGS
export BLAS_LIBS
export LAPACK_LIBS
export R_INCLUDE_DIR

RCPP_DIR=$(${R_HOME}/bin/Rscript -e "cat(system.file(package='Rcpp'))")
export RCPP_DIR
cd src

# Download VTK source
${R_HOME}/bin/Rscript -e "utils::download.file(
    url = 'https://www.vtk.org/files/release/9.0/VTK-9.0.1.tar.gz',
    destfile = 'vtk-src.tar.gz')"

# Uncompress VTK source
${R_HOME}/bin/Rscript -e "utils::untar(tarfile = 'vtk-src.tar.gz')"
mv VTK-9.0.1 vtk-src

# Build VTK
rm -fr vtk-build
rm -fr vtk-install
cmake \
	-D CMAKE_BUILD_TYPE:STRING=“Release” \
	-D BUILD_SHARED_LIBS=ON \
	-D VTK_GROUP_ENABLE_Imaging=NO \
	-D VTK_GROUP_ENABLE_MPI=NO \
	-D VTK_GROUP_ENABLE_Qt=NO \
	-D VTK_GROUP_ENABLE_StandAlone=NO \
	-D VTK_GROUP_ENABLE_Views=NO \
	-D VTK_GROUP_ENABLE_Web=NO \
	-D VTK_MODULE_ENABLE_VTK_CommonCore=YES \
	-D VTK_MODULE_ENABLE_VTK_CommonExecutionModel=YES \
	-D VTK_MODULE_ENABLE_VTK_CommonMath=YES \
	-D VTK_MODULE_ENABLE_VTK_CommonMisc=YES \
	-D VTK_MODULE_ENABLE_VTK_CommonSystem=YES \
	-D VTK_MODULE_ENABLE_VTK_CommonTransforms=YES \
	-D VTK_MODULE_ENABLE_VTK_IOCore=YES \
	-D VTK_MODULE_ENABLE_VTK_IOLegacy=YES \
	-D VTK_MODULE_ENABLE_VTK_IOXML=YES \
	-D VTK_MODULE_ENABLE_VTK_IOXMLParser=YES \
	-S vtk-src \
	-B vtk-build
NCORES=`${R_HOME}/bin/Rscript -e "cat(parallel::detectCores(logical = FALSE))"`
cmake --build vtk-build -j ${NCORES} --clean-first
cmake --install vtk-build --prefix vtk-install

# Cleanup VTK files
rm -fr vtk-src
rm -fr vtk-build
rm -f vtk-src.tar.gz

# Compile trio library
cmake -DVTK_DIR=vtk-install/lib/cmake/vtk-9.0 -DCMAKE_BUILD_TYPE=Release . $@
