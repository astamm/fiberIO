#! /bin/bash
# obtain and export Rs environment variables
export R_HOME
CXX=$(${R_HOME}/bin/R CMD config CXX)
CXXFLAGS="$(${R_HOME}/bin/R CMD config CXXFLAGS)"
CPPFLAGS=$(${R_HOME}/bin/R CMD config CPPFLAGS)
BLAS_LIBS=$(${R_HOME}/bin/R CMD config BLAS_LIBS)
LAPACK_LIBS=$(${R_HOME}/bin/R CMD config LAPACK_LIBS)
export CXX
export CXXFLAGS
export CPPFLAGS
export BLAS_LIBS
export LAPACK_LIBS
export R_INCLUDE_DIR

RCPP_DIR=$(${R_HOME}/bin/Rscript -e "cat(system.file(package='Rcpp'))")
export RCPP_DIR
cd src

# Download VTK source
${R_HOME}/bin/Rscript -e "utils::download.file(
    url = 'https://www.vtk.org/files/release/9.0/VTK-9.0.1.tar.gz',
    destfile = 'vtk-src.tar.gz')"

# Uncompress VTK source
${R_HOME}/bin/Rscript -e "utils::untar(tarfile = 'vtk-src.tar.gz')"
mv VTK-9.0.1 vtk-src

# Build VTK
mkdir -p vtk-build
NCORES=`${R_HOME}/bin/Rscript -e "cat(parallel::detectCores(logical = FALSE))"`
cmake -DCMAKE_BUILD_TYPE=Release -S vtk-src -B vtk-build
cmake --build vtk-build -j ${NCORES} --clean-first

# Cleanup VTK files
rm -fr vtk-src
rm -f vtk-src.tar.gz

# VTKDIR=`find $HOME -mindepth 1 -maxdepth 1 -type d -perm -o=r -print0 | while read -d $'\0' folder
# do
#     find $folder -name VTKConfig.cmake -print0 | while read -d $'\0' infolder
#     do
#         if [[ $infolder =~ "CMakeFiles" ]]; then
#             continue
#         fi
#         echo $infolder | rev | cut -d'/' -f2- | rev
#     done
# done`

# cmake -DVTK_DIR=$VTKDIR -DCMAKE_BUILD_TYPE=Release . $@
cmake -DVTK_DIR=vtk-build -DCMAKE_BUILD_TYPE=Release . $@
